version: "3.9"
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: yseeku
      POSTGRES_USER: yseeku
      POSTGRES_DB: yseeku
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  mongo:
    image: mongo:6
    ports:
      - "27017:27017"
    volumes:
      - mongodata:/data/db

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  backend:
    build:
      context: ./apps/backend
    env_file:
      - ./apps/backend/.env.example
    environment:
      PORT: 3001
      MONGODB_URI: mongodb://mongo:27017/yseeku
      CORS_ORIGIN: http://localhost:5000
      DEMO_ROUTES_ENABLED: "false"
      SECRETS_PROVIDER: ${SECRETS_PROVIDER:-local}
      VAULT_ENDPOINT: ${VAULT_ENDPOINT:-}
      VAULT_TOKEN: ${VAULT_TOKEN:-}
      TRUST_SIGNING_PRIVATE_KEY_REF: ${TRUST_SIGNING_PRIVATE_KEY_REF:-}
    depends_on:
      - mongo
      - redis
    ports:
      - "3001:3001"

  web:
    build:
      context: ./apps/web
    environment:
      NEXT_PUBLIC_BACKEND_URL: http://backend:3001
      DATABASE_URL: postgresql://yseeku:yseeku@postgres:5432/yseeku
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DETECT_EMBEDDINGS_PROVIDER: ${DETECT_EMBEDDINGS_PROVIDER:-together}
      DETECT_EMBEDDINGS_MODEL: ${DETECT_EMBEDDINGS_MODEL:-BAAI/bge-small-en-v1.5}
      TOGETHER_API_KEY: ${TOGETHER_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      HF_API_TOKEN: ${HF_API_TOKEN:-}
      DEMO_ROUTES_ENABLED: "false"
    depends_on:
      - backend
      - postgres
      - redis
    ports:
      - "5000:5000"

volumes:
  pgdata:
  mongodata:

